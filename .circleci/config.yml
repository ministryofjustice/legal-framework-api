version: 2.1

workflows:
  test-env-vars:
    jobs:
      - build:
          context: legal-framework-api-uat

jobs:
  build:
    docker:
      - image: ${ECR_ENDPOINT}/cloud-platform/tools:circleci-internal
        environment:
          IMAGE_URI: ${ECR_ENDPOINT}/legal-framework-api
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build application Docker image and push to ECR
          command: |
            $(aws ecr get-login --no-include-email)
            docker build \
            --build-arg BUILD_DATE=$(date +%Y-%m-%dT%H:%M:%S%z) \
            --build-arg BUILD_TAG="app-${CIRCLE_SHA1}" \
            --build-arg APP_BRANCH=${CIRCLE_BRANCH} \
            -t app .
            docker push ${ECR_ENDPOINT}/legal-framework-api
      - run:
          name: Authenticate with cluster
          command: |
            echo -n ${K8S_CLUSTER_CERT} | base64 -d > ./ca.crt
            kubectl config set-cluster ${K8S_CLUSTER_NAME} --certificate-authority=./ca.crt --server=https://api.${K8S_CLUSTER_NAME}
            kubectl config set-credentials circleci --token=${K8S_TOKEN}
            kubectl config set-context ${K8S_CLUSTER_NAME} --cluster=${K8S_CLUSTER_NAME} --user=circleci --namespace=${K8S_NAMESPACE}
            kubectl config use-context ${K8S_CLUSTER_NAME}
      - run:
          name: Install demo helm chart
          command: |
            echo "Installing demoo helm chart"
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              helm upgrade demo helm_deploy --install --namespace=${K8S_NAMESPACE}
            fi
            kubectl --namespace=${K8S_NAMESPACE} get pods
